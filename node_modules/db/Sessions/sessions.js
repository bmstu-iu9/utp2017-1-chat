var fs = require('fs');
var log = require('tech').log;
var config = require('config');
var Session = require('./Session');

var path = __dirname + '/sessions.json';
var sessions;

/*
exports.connect = function() {
    sessions = require('./sessions.json');
};
*/
exports.connect = function() {
    try {
        sessions = JSON.parse(fs.readFileSync(path, 'utf-8'));
    } catch (err) {
        if (err.message.indexOf("ENOENT") == 0) {
            log.info("Файла с сессиями нет, но сейчас попробую создать!");
            fs.writeFileSync(path, JSON.stringify({ "Sessions": [] }, '', 4), 'utf-8');
            log.info("Создано!");
        } else log.error(err);
        sessions = {"Sessions": [] };
    }
};

exports.getSession = function(ID) {
    return new Promise(function(resolve, reject) {
        log.debug("Получения сессии " + ID);
        fs.readFile(path, 'utf-8', function(err, db) {
            if (err) {
                log.error(err);
                reject(err);

            } else {
                db = JSON.parse(db);
                resolve(contain(db, ID));
            }
        });
    });
};

exports.addSession = function(login, date) { //may contain some another fields
    return new Promise(function(resolve, reject) {
        log.debug("Добавление сессии от  " + login + " " + date);
        fs.readFile(path, 'utf-8', function(err, db) {
            if (err) {
                log.error(err);
                reject(err);

            } else {
                db = JSON.parse(db);

                var ID = IDExtra();
                var x = new Session(ID, login, date);
                db.Sessions.push(x);

                db = JSON.stringify(db, '', 4);

                fs.writeFile(path, db, 'utf-8', function(err) {
                    if (err) {
                        log.error(err);
                        reject(err);
                    } else
                        resolve(x.sessionID);
                });
            }
        });
    });
};

exports.deleteSession = function(ID) {
    return new Promise(function(resolve, reject) {
        log.debug("Удаление сессиии " + ID);
        fs.readFile(path, 'utf-8', function(err, db) {
            if (err) {
                log.error(err);
                reject(err);

            } else {
                db = JSON.parse(db);

                var r = contain(db, ID);

                if (!r) {
                    log.info("No such user");
                    reject("No such user");

                } else {
                    db.Sessions.splice(db.Sessions.indexOf(r), 1);
                    db = JSON.stringify(db, '', 4);

                    fs.writeFile(path, db, 'utf-8', function(err) {
                        if (err) {
                            log.error(err);
                            reject(err);
                        }
                    });

                    resolve(true);
                }
            }
        });
    });
};

exports.deleteOldSessions = function() {
    return new Promise(function(resolve, reject) {
        log.debug("Удаление старых сессий");
        fs.readFile(path, 'utf-8', function(err, db) {
            if (err) {
                log.error(err);
                reject(err);

            } else {
                db = JSON.parse(db);

                var x = new Date().getTime();
                for (var i = 0; i < db.Sessions.length;) {
                    if (db.Sessions[i].date < x)
                        db.Sessions.splice(i, 1);
                    else
                        i++;
                }

                db = JSON.stringify(db, '', 4);

                fs.writeFile(path, db, 'utf-8', function(err) {
                    if (err) {
                        log.error(err);
                        reject(err);
                    } else {
                        resolve(true);
                    }
                });

            }
        });
    });
};

function contain(db, ID) {
    var r;
    for (var i = 0; i < db.Sessions.length; i++)
        if (db.Sessions[i].sessionID == ID)
            r = db.Sessions[i];
    return r;
}

exports.deleteAllSessions = function() {
    log.debug("Удаление всех сессий");
    var n = {
        Sessions: []
    };

    fs.writeFile(path, JSON.stringify(n, '', 4), 'utf-8', function(err) {
        if (err)
            throw new Error(err);
    });
};

function IDExtra() { //generate salt
    var str = "";
    for (var i = 0; i < config.SESSION_ID_LENGTH;) {
        var x = Math.floor(Math.random() * (123 - 48)) + 48;
        if (x <= 57 || (x >= 65 && x <= 90) || x >= 97) {
            str += String.fromCharCode(x);
            i++;
        }
    }
    return str;
}